<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Network Access Auto-Detect → Zapier</title>
<style>
  :root{--bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--accent:#60a5fa}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:28px}
  .card{background:var(--panel);border-radius:16px;padding:22px;box-shadow:0 10px 24px rgba(0,0,0,.45)}
  h1{font-size:1.25rem;margin:0 0 8px} p{color:var(--muted);margin:6px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.95rem;background:#0a0f1a;padding:12px;border-radius:12px;word-break:break-all}
  .ok{color:#10b981} .err{color:#ef4444}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Detecting Network Access…</h1>
      <p>This page determines whether the device is on <strong>Wi-Fi</strong> or <strong>Cellular</strong> where supported and sends the result to Zapier.</p>
      <div id="log" class="mono">Initializing…</div>
    </div>
  </div>

<script>
(async () => {
  const ZAPIER_WEBHOOK = "https://hooks.zapier.com/hooks/catch/XXXX/YYYY/"; // ← replace

  const logEl = document.getElementById('log');
  const log = (msg, cls) => { logEl.textContent = msg; logEl.className = "mono" + (cls ? " " + cls : ""); };

  function detectNetworkAccess() {
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection || null;
    const ua = navigator.userAgent || "";

    const info = {
      connectionTypeRaw: conn && ('type' in conn) ? conn.type : null,   // 'wifi' | 'cellular' (rare)
      effectiveType: conn && conn.effectiveType || null,                // '4g' | '3g' | '2g' | 'slow-2g'
      downlink: (conn && typeof conn.downlink === 'number') ? conn.downlink : null, // Mbps
      rtt: (conn && typeof conn.rtt === 'number') ? conn.rtt : null,    // ms
      saveData: (conn && typeof conn.saveData === 'boolean') ? conn.saveData : null,
      userAgent: ua,
      platform: navigator.platform || null,
      userAgentDataMobile: (navigator.userAgentData && 'mobile' in navigator.userAgentData) ? navigator.userAgentData.mobile : null,
    };

    let access = "unknown";
    if (info.connectionTypeRaw === "wifi") access = "wifi";
    else if (info.connectionTypeRaw === "cellular") access = "cellular";

    return { access, info };
  }

  function toFormData(obj) {
    const fd = new FormData();
    Object.entries(obj).forEach(([k, v]) => {
      const val = (v === null || v === undefined) ? "" : (typeof v === "object" ? JSON.stringify(v) : String(v));
      fd.append(k, val);
    });
    return fd;
  }

  async function sendToZapierSimple(payload) {
    // Simple request: no headers, FormData body → no preflight/CORS error
    const body = toFormData(payload);
    // Do NOT set headers. Do NOT set content-type. Let the browser handle it.
    // Avoid mode:'no-cors' unless you truly don't care about response visibility.
    const res = await fetch(ZAPIER_WEBHOOK, { method: "POST", body });
    return res;
  }

  function sendWithBeaconFallback(payload) {
    try {
      const ok = navigator.sendBeacon(
        ZAPIER_WEBHOOK,
        new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }) // simple content-type
      );
      return ok;
    } catch { return false; }
  }

  try {
    const { access, info } = detectNetworkAccess();
    const payload = {
      timestamp: new Date().toISOString(),
      network_access: access,                // "wifi" | "cellular" | "unknown"
      connection_type_raw: info.connectionTypeRaw,
      effective_type: info.effectiveType,
      downlink_mbps: info.downlink,
      rtt_ms: info.rtt,
      save_data: info.saveData,
      user_agent: info.userAgent,
      platform: info.platform,
      user_agent_data_mobile: info.userAgentDataMobile,
      page_url: location.href
    };

    log(`Detected access: ${access}\n\nDetails:\n${JSON.stringify(info, null, 2)}`);

    try {
      const res = await sendToZapierSimple(payload);
      if (!res.ok) throw new Error(`Zapier responded ${res.status}`);
      log(`Sent to Zapier ✅\n\n${JSON.stringify(payload, null, 2)}`, "ok");
    } catch (e) {
      // Fall back to sendBeacon (no preflight, text/plain) — publish Zap as "Catch Raw Hook" if you want raw body
      const ok = sendWithBeaconFallback(payload);
      if (ok) {
        log(`Sent via Beacon ✅ (response not readable in page)\n\n${JSON.stringify(payload, null, 2)}`, "ok");
      } else {
        throw e;
      }
    }

    // Optional: listen for connection changes and re-send
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection || null;
    if (conn && typeof conn.addEventListener === "function") {
      conn.addEventListener("change", async () => {
        const { access, info } = detectNetworkAccess();
        const payload2 = { ...payload, timestamp: new Date().toISOString(), network_access: access, connection_type_raw: info.connectionTypeRaw, effective_type: info.effectiveType, downlink_mbps: info.downlink, rtt_ms: info.rtt, save_data: info.saveData, event: "connectionchange" };
        try {
          await sendToZapierSimple(payload2);
          log(`Change detected & sent ✅\n\n${JSON.stringify(payload2, null, 2)}`, "ok");
        } catch {
          sendWithBeaconFallback(payload2);
          log(`Change detected & sent via Beacon ✅\n\n${JSON.stringify(payload2, null, 2)}`, "ok");
        }
      });
    }
  } catch (err) {
    log(`Failed to send ❌\n${err}`, "err");
    console.error(err);
  }
})();
</script>
</body>
</html>
