<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Connection Check (Training)</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; }
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:24px}
  .card{background:var(--panel);border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 12px;font-size:1.5rem}
  p{color:var(--muted);line-height:1.6}
  button{background:var(--accent);border:none;color:#0b1220;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{font-size:.9rem;color:var(--muted)}
  pre{white-space:pre-wrap;background:#0b1220;border-radius:12px;padding:12px;overflow:auto}
  .ok{color:#86efac} .err{color:#fca5a5}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Connection Check (Training)</h1>
      <p>
        This page is for an educational cybersecurity exercise. By continuing, you consent to sharing basic
        connection info (public IP/ISP/ASN, browser, and network hints) with the organizer.
      </p>
      <p class="muted">No cookies. No tracking beyond this one report.</p>
      <button id="consentBtn">I Consent &amp; Continue</button>
      <div id="status" class="muted" style="margin-top:12px;"></div>
      <pre id="preview" style="display:none"></pre>
      <p class="muted" id="foot"></p>
    </div>
  </div>

<script>
/** ===================== CONFIG ===================== **/
const WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/24106739/udw39uu/"; // your Catch Hook
const SHOW_PREVIEW = true; // set to false to hide the JSON preview

/** ================ HELPERS (no keys needed) ================ **/
function getConnHints(){
  const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  return c ? {
    effectiveType: c.effectiveType || null,  // '4g','3g','slow-2g' (varies; iOS may be null)
    downlink: c.downlink ?? null,            // Mbps approx
    rtt: c.rtt ?? null,                      // ms approx
    saveData: !!c.saveData
  } : {};
}

function labelLikelyConnection(org, hints){
  const orgStr = (org || "").toLowerCase();
  const mobileMarkers = [
    "wireless","mobility","mobile","cellular","verizon","at&t","t-mobile","tmobile",
    "telecom","vodafone","orange","o2","telefonica","rogers","bell","telus","docomo"
  ];
  const isMobileASN = mobileMarkers.some(m => orgStr.includes(m));
  const eff = (hints?.effectiveType || "").toLowerCase();
  const isMobileHint = ["2g","3g","4g","5g","slow-2g"].includes(eff);
  if (isMobileASN || isMobileHint) return "Likely Cellular";
  if (org) return "Likely Wi-Fi/Ethernet";
  return "Unknown";
}

async function fetchIPMeta(){
  try{
    const r = await fetch("https://ipapi.co/json/");
    if(!r.ok) throw new Error("ipapi.co error");
    const j = await r.json();
    return {
      ip: j.ip || null,
      asn: j.asn || null,
      org: j.org || j.org_name || null,
      city: j.city || null,
      region: j.region || null,
      country: j.country_name || j.country || null,
      latitude: j.latitude ?? null,
      longitude: j.longitude ?? null
    };
  }catch(e){
    try{
      const r2 = await fetch("https://api.ipify.org?format=json");
      const j2 = await r2.json();
      return { ip: j2.ip || null };
    }catch(_){ return {}; }
  }
}

/** ======= CORS-proof sender: GET with ?q=<JSON> ======= **/
function deliver(payload){
  return new Promise((resolve)=>{
    const img = new Image();
    const q = encodeURIComponent(JSON.stringify(payload));
    img.onload  = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = WEBHOOK_URL + "?q=" + q; // Zapier will receive `q` as a string
  });
}

/** ===================== MAIN ======================= **/
const consentBtn = document.getElementById("consentBtn");
const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const footEl = document.getElementById("foot");

consentBtn.addEventListener("click", async () => {
  consentBtn.disabled = true;
  statusEl.textContent = "Collecting connection info…";

  const ts = new Date().toISOString();
  const ua = navigator.userAgent;
  const platform = navigator.platform || null;
  const lang = navigator.language || (navigator.languages && navigator.languages[0]) || null;
  const deviceMemory = navigator.deviceMemory || null;
  const screenSize = `${window.screen.width}x${window.screen.height}`;
  const viewport = `${window.innerWidth}x${window.innerHeight}`;

  const hints = getConnHints();
  const ipmeta = await fetchIPMeta();
  const likely = labelLikelyConnection(ipmeta.org, hints);

  const payload = {
    timestamp: ts,
    public_ip: ipmeta.ip || null,
    asn: ipmeta.asn || null,
    org: ipmeta.org || null,
    geo: {
      city: ipmeta.city || null,
      region: ipmeta.region || null,
      country: ipmeta.country || null,
      lat: ipmeta.latitude || null,
      lon: ipmeta.longitude || null
    },
    user_agent: ua,
    platform,
    language: lang,
    device_memory_gb: deviceMemory,
    screen: screenSize,
    viewport,
    connection_hints: hints,
    inferred_connection: likely
  };

  if (SHOW_PREVIEW){
    previewEl.style.display = "block";
    previewEl.textContent = JSON.stringify(payload, null, 2);
  }

  const ok = await deliver(payload);
  statusEl.innerHTML = ok
    ? `<span class="ok">✓ Report sent successfully.</span>`
    : `<span class="err">✗ Could not send to webhook. Check your WEBHOOK_URL.</span>`;

  footEl.textContent = "Tip: Generate a QR code for this page URL to use in your class exercise.";
  consentBtn.disabled = false;
});
</script>
</body>
</html>
